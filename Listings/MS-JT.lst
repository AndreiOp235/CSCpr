C51 COMPILER V8.02   MS_JT                                                                 03/10/2025 17:13:24 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MS_JT
OBJECT MODULE PLACED IN .\Objects\MS-JT.obj
COMPILER INVOKED BY: D:\Apps\Keil\C51\BIN\C51.EXE MS-JT.c LARGE BROWSE INCDIR(.\BIG8051\Include) DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\MS-JT.lst) OBJECT(.\Objects\MS-JT.obj)

line level    source

   1          #include <c8051F040.h>  // declaratii SFR
   2          #include <wdt.h>
   3          #include <osc.h>
   4          #include <port.h>
   5          #include <uart0.h>
   6          #include <uart1.h>
   7          #include <lcd.h>
   8          #include <keyb.h>
   9          #include <Protocol.h>
  10          #include <UserIO.h>
  11          
  12          nod retea[NR_NODURI];                           // retea cu 3 noduri
  13          
  14          unsigned char STARE_COM = 0;            // starea initiala a FSA COM
  15          unsigned char STARE_IO  = 0;            // stare initiala FSA interfata IO - asteptare comenzi
  16          unsigned char TIP_NOD   = 0;            // tip nod initial: Slave sau No JET
  17          unsigned char ADR_MASTER;                       // adresa nod master - numai MS
  18          
  19          extern unsigned char AFISARE;           // flag permitere afisare
  20          
  21          //********************************************************************************************************
             -***
  22          void TxMesaj(unsigned char i);                          // transmisie mesaj destinat nodului i
  23          unsigned char RxMesaj(unsigned char i);         // primire mesaj de la nodul i
  24          
  25          //********************************************************************************************************
             -***
  26          void main (void) {
  27   1              unsigned char i, found;                         // variabile locale
  28   1              
  29   1              WDT_Disable();                                                  // dezactiveaza WDT
  30   1              SYSCLK_Init();                                                  // initializeaza si selecteaza oscilatorul ales in osc.h
  31   1              UART1_Init(NINE_BIT, BAUDRATE_COM);             // initilizare UART1 - port comunicatie (TxD la P1.0 si RxD la P1.1)
  32   1              UART1_TxRxEN (1,1);                                             // validare Tx si Rx UART1
  33   1              
  34   1              PORT_Init ();                                                   // conecteaza perifericele la pini (UART0, UART1) si stabileste tipul pinilor
  35   1      
  36   1              LCD_Init();                                                     // 2 linii, display ON, cursor OFF, pozitia initiala (0,0)
  37   1              KEYB_Init();                                                    // initializare driver tastatura matriciala locala
  38   1              UART0_Init(EIGHT_BIT, BAUDRATE_IO);             // initializare UART0  - conectata la USB-UART (P0.0 si P0.1)
  39   1      
  40   1              Timer0_Init();                                                  // initializare Timer 0
  41   1      
  42   1              EA = 1;                                         // valideaza intreruperile
  43   1              SFRPAGE = LEGACY_PAGE;                          // selecteaza pagina 0 SFR
  44   1              
  45   1              for(i = 0; i < NR_NODURI; i++){         // initializare structuri de date
  46   2                      retea[i].full = 0;                                      // initializeaza buffer gol pentru toate nodurile
  47   2                      retea[i].bufasc[0] = ':';                       // pune primul caracter in buffer-ele ASCII ':'
  48   2              }
  49   1      
  50   1              Afisare_meniu();                                                // Afiseaza meniul de comenzi
  51   1              
  52   1              while(1){                                                               // bucla infinita
C51 COMPILER V8.02   MS_JT                                                                 03/10/2025 17:13:24 PAGE 2   

  53   2                                                                                                                                      
  54   2                      switch(STARE_COM){
  55   3                              case 0:
  56   3      
  57   3      #if(PROTOCOL == MS)                                                     // nodul este slave, asteapta mesaj complet si corect de la master      
  58   3      
  59   3                                      switch(RxMesaj(ADR_NOD)){                       // asteapta un mesaj de la master
  60   4                                              case TMO:                                                       
  61   4                                                      
  62   4                                                                                                                      // anunta ca nodul curent devine master ???
  63   4                                                      TIP_NOD=MASTER;                                                         // nodul curent devine master
  64   4                                                      Afisare_meniu();                                                                // Afiseaza meniul de comenzi
  65   4                                                      STARE_COM=2;                                                            // trece in starea 2
  66   4                                                                                                                      // primul slave va fi cel care urmeaza dupa noul master ????
  67   4                                                                      break;
  68   4      
  69   4                                              case ROK:                                                                       
  70   4                                                      Afisare_mesaj();
  71   4                                                      break;  // a primit un mesaj de la master, il afiseaza
  72   4                                              case POK:       
  73   4                                                      STARE_COM = 1;                                  
  74   4                                                      break;  // si trebuie sa raspunda
  75   4                                              case CAN:
  76   4                                                      Error("Mesaj incomplet");                                                               
  77   4                                                      break;  // afiseaza eroare Mesaj incomplet
  78   4                                              case TIP:                                                                       
  79   4                                                      Error("Tip mesaj necunoscut");
  80   4                                                      break;  // afiseaza eroare Tip mesaj necunoscut
  81   4                                              case ESC:
  82   4                                                      Error("Eroare SC");                                                                     
  83   4                                                      break;  // afiseaza Eroare SC
  84   4                                              default:
  85   4                                                      Error("cod UNK");
  86   4                                                      Delay(1000);
  87   4                                                      break;  // afiseaza cod eroare necunoscut, asteapta 1 sec
  88   4                                      }
  89   3      #endif
  90   3      
  91   3      #if(PROTOCOL == JT)                                                                     // nodul nu detine jetonul, asteapta un mesaj util sau jetonul
                                              
                                              switch(RxMesaj(ADR_NOD)){                               // asteapta jetonul de la master
                                                      
                                                      case TMO:                                                               // a primit un mesaj USER_MES
                                                                                                                                              // anunta ca nodul a regenerat jetonul 
                                                                                                                                              // nodul curent detine jetonul
                                                                                                                                              // Daca e permisa afisarea, afiseaza meniul de comenzi
                                                                                                                                              // trece in starea 1
                                                              break;
              
                                                      
                                                      case JOK:                                                               // a primit jetonul
                                                              
                                                              Delay(WAIT/2);                                          // asteapta WAIT/2 ms
                                                      
                                                                                                                                                                                              // adresa HW dest este adr_hw_src
                                                                                                                                                                                              // adresa HW src este ADR_NOD
                                                                                                                                                                                              // tip mesaj = JET_MES
                                                                                                                                                                                              // transmite mesajul JET_MES din bufferul ADR_NOD
                                                                                                                                                                                              // nodul curent detine jetonul
                
                                              }
              #endif                                                          
C51 COMPILER V8.02   MS_JT                                                                 03/10/2025 17:13:24 PAGE 3   

 115   3                                      break;
 116   3      
 117   3                              case 1:                                                                                 
 118   3      
 119   3      #if(PROTOCOL == MS)                                                                             // nodul este slave, transmite mesaj catre master                       
 120   3                                                                                                                                      
 121   3                                                                                                                                                      // cauta sa gaseasca un mesaj util de transmis   ????
 122   3                                                                                                      
 123   3                                                                                                                                      
 124   3                                                                                                                                      
 125   3                                                                                                                              
 126   3                                                                                                                      
 127   3                                      if(found)                                                                                                       // daca gaseste un nod i
 128   3                                      {
 129   4                                      retea[i].bufbin.adresa_hw_dest=ADR_MASTER;                                      // adresa HW dest este ADR_MASTER
 130   4                                      TxMesaj(i);                                                                                     // transmite mesajul pentru nodul i                             
 131   4                                      }                                                                                                       
 132   3                                      else
 133   3                                      {
 134   4                                                                                                                                                      // daca nu gaseste, construieste un mesaj in bufferul ADR_MASTER
 135   4                                              retea[ADR_MASTER].bufbin.adresa_hw_dest=ADR_MASTER;                     // adresa HW dest este ADR_MASTER
 136   4                                              retea[ADR_MASTER].bufbin.adresa_hw_src=ADR_NOD;                         // adresa HW src este ADR_NOD
 137   4                                              retea[ADR_MASTER].bufbin.tipmes= POLL_MES;                                              // tip mesaj = POLL_MES
 138   4                                              TxMesaj(ADR_MASTER);                                                                    // transmite mesajul din bufferul ADR_MASTER
 139   4                                      }
 140   3                                                                                                                                      
 141   3                                                                                                                                                      
 142   3                                                                                                                              
 143   3                                              STARE_COM=0;                                                                                    // trece in starea 0, sa astepte un nou mesaj de la master
 144   3                                      break;
 145   3      #endif
 146   3      
 147   3      #if(PROTOCOL == JT)                                                     // nodul detine jetonul, poate transmite un mesaj USER_MES                              
              
                                                                                                                                                                                              // asteapta procesarea mesajului la destinatie (WAIT/2 msec)
              #endif  
 151   3                                      
 152   3                              break;  
 153   3                                      
 154   3                              case 2:
 155   3                                                                                                                              // tratare stare 2 si comutare stare
 156   3      
 157   3      #if(PROTOCOL == MS)                                                                                     // nodul este master, tratare stare 2 si comutare stare
 158   3                                      if(++i==ADR_NOD)                                                   // selecteaza urmatorul slave (incrementeaza i si sare peste adresa proprie)
 159   3                                              i++;
 160   3                                      else if(i>NR_NODURI)
 161   3                                              i=0;                                                                                                                            
 162   3                                                                                                                                              
 163   3      
 164   3                                      retea[ADR_NOD].bufbin.adresa_hw_dest=i;                                                                                                 // adresa HW dest este i
 165   3                                      if(1)
 166   3                                      {
 167   4                                                                                                                                        // daca in bufferul i se afla un mesaj util, il transmite      ????
 168   4                                      }
 169   3                                      else
 170   3                                      {
 171   4                                                                                                                                        // altfel, construieste un mesaj de interogare in bufferul i
 172   4                                              retea[ADR_NOD].bufbin.adresa_hw_src=ADR_NOD;                    // adresa HW src este ADR_NOD
 173   4                                              retea[ADR_NOD].bufbin.tipmes=POLL_MES;                                  // tip mesaj = POLL_MES
 174   4                                              TxMesaj(i);                                                                             // transmite mesajul din bufferul i
 175   4                                      }                                                                                                       
 176   3                                                                                                                                              
C51 COMPILER V8.02   MS_JT                                                                 03/10/2025 17:13:24 PAGE 4   

 177   3                                      STARE_COM=3;                                                                            // trece in starea 3, sa astepte raspunsul de la slave-ul i
 178   3      
 179   3      #endif
 180   3      
 181   3      #if(PROTOCOL == JT)                                                                                     // nodul transmite jetonul urmatorului nod              
                                                                                                                                                                              // asteapta WAIT/2 sec
                                                                                                                                                                              // trece in starea 3, sa astepte confirmarea de la nodul i ca jetonul a fost primit
              #endif
 185   3      
 186   3                              break;
 187   3      
 188   3                              case 3:
 189   3      
 190   3      #if(PROTOCOL == MS)                                                                             // nodul este master, asteapta mesaj de la slave        
 191   3                                                                                                                                      
 192   3                                      switch(RxMesaj(i)){                                                             // asteapta un raspuns de la slave i
 193   4                                                      case TMO: {
 194   5                                                                                      char errMsg[20] = "Timeout nod ";  // Base string
 195   5                                                                                      errMsg[12] = i;  // Append character
 196   5                                                                                      errMsg[13] = '\0'; // Null terminate
 197   5                                                                                      Error(errMsg);
 198   5                                                                              break;
 199   5                                                                              }
 200   4      
 201   4                                              case ROK:                                                                                                       
 202   4                                                      if(retea[ADR_NOD].bufbin.tipmes==USER_MES)       // a primit un mesaj de date, il afiseaza
 203   4                                                                Afisare_mesaj();
 204   4                                              break;                                                                                          // a primit un mesaj de interogare, trece mai departe
 205   4                                                      
 206   4                                                                                                                                                                                      
 207   4                                              case ERI: Error("Eroare incadrare");                                            break;  // afiseaza Eroare incadrare
 208   4                                              case ERA: Error("Eroare adresa");                                                       break;  // afiseaza Eroare adresa
 209   4                                              case TIP: Error("Tip mesaj necunoscut");                                        break;  // afiseaza Tip mesaj necunoscut
 210   4                                              case OVR: Error("Eroare adresa");                                                       break;  // afiseaza Eroare suprapunere
 211   4                                              case ESC: Error("Eroare adresa");                                                       break;  // afiseaza Eroare SC
 212   4                                              case CAN: Error("Eroare adresa");                                                       break;  // afiseaza mesaj incomplet
 213   4      
 214   4                                              default:
 215   4                                              Error("Eroare adresa");
 216   4                                              Delay(1000);
 217   4                                              break;  // afiseaza Eroare necunoscuta, apoi asteapta 1000ms
 218   4                                      }
 219   3                                      STARE_COM=2;                                                                                                    // revine in starea 2 (a primit sau nu un raspuns de la slave, trece la urmat
             -orul slave)
 220   3      #endif
 221   3      
 222   3                              
 223   3      #if(PROTOCOL == JT)                                                                                             // asteapta confirmarea primirii jetonului de care nodul i              
                                              switch(RxMesaj(i)){                                                                     // asteapta un raspuns de la nod i
                                                      case TMO:                                                                                                                               // afiseaza eroare Timeout nod i
                                                                              
              
                                                                                                                                                                                                      // revine in starea 2 (nu a primit raspuns)
                                                                              break;
                                                      case JOK:                                                                                                                               // a primit confirmarea transferului jetonului, revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // daca afisarea e permisa, afiseaza meniul
                                                                              break;
                                                      case ERI:                                                                                                                               // afiseaza Eroare incadrare
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
C51 COMPILER V8.02   MS_JT                                                                 03/10/2025 17:13:24 PAGE 5   

                                                                                              break;                  
                                                      case ERA:                                                                                                                               // afiseaza Eroare adresa
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
                                                                                              break;                  
                                                      
                                                      case CAN:                                                                                                                               // afiseaza Mesaj incomplet
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
                                                                                              break;                  
                                                      
                                                      case TIP:                                                                                                                               // afiseaza Tip mesaj necunoscut
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
                                                                                              break;                  
                                                      
                                                      case ESC:                                                                                                                               // afiseaza Eroare SC
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
                                                                                              break;                  
              
                                                      default:                                                                                                                                // afiseaza Eroare necunoscuta
                                                                                                                                                                                                                      // asteapta 1000 ms
                                                                                                                                                                                                                      // revine in starea 0
                                                                                                                                                                                                                      // nodul nu mai detine jetonul
                                                                                                                                                                                                                      // afiseaza meniul
                                                                                              break;                  
                                      }
                                              
              #endif
 272   3                              
 273   3                              break;                  
 274   3                      }
 275   2                      
 276   2                      UserIO();                                                       // apel functie interfata
 277   2              }
 278   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    559    ----
   CONSTANT SIZE    =    106    ----
   XDATA SIZE       =    169      22
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
